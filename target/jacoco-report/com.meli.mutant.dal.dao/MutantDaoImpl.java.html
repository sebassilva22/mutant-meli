<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MutantDaoImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mutant-challenge</a> &gt; <a href="index.source.html" class="el_package">com.meli.mutant.dal.dao</a> &gt; <span class="el_source">MutantDaoImpl.java</span></div><h1>MutantDaoImpl.java</h1><pre class="source lang-java linenums">package com.meli.mutant.dal.dao;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import com.meli.mutant.exception.DnaException;
import com.meli.mutant.model.Statistics;

import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import software.amazon.awssdk.services.dynamodb.model.AttributeValue;
import software.amazon.awssdk.services.dynamodb.model.ConditionalCheckFailedException;
import software.amazon.awssdk.services.dynamodb.model.PutItemRequest;
import software.amazon.awssdk.services.dynamodb.model.ScanRequest.Builder;
import software.amazon.awssdk.services.dynamodb.model.ScanResponse;
import software.amazon.awssdk.services.dynamodb.model.ResourceNotFoundException;
import software.amazon.awssdk.services.dynamodb.model.ScanRequest;
import software.amazon.awssdk.services.dynamodb.model.Select;

public class MutantDaoImpl implements IMutantDao {
	private DynamoDbClient dynamoDb;
	private String tableName;
	private static final String ID = &quot;pk&quot;;
	private static final String DNA = &quot;dna&quot;;
	private static final String IS_MUTANT = &quot;isMutant&quot;;
	
<span class="fc" id="L27">	public MutantDaoImpl(DynamoDbClient dynamoDb, String tableName) {</span>
<span class="fc" id="L28">		this.tableName =  tableName;</span>
<span class="fc" id="L29">		this.dynamoDb = dynamoDb;</span>
<span class="fc" id="L30">	}</span>

	@Override
	public void registerMutant(String dna, boolean isMutant) throws DnaException {
		try {
<span class="fc" id="L35">            Map&lt;String, AttributeValue&gt; insert = transformDtoToMap(dna, isMutant);</span>
<span class="fc" id="L36">            dynamoDb.putItem(PutItemRequest.builder()</span>
<span class="fc" id="L37">                    .tableName(tableName)</span>
<span class="fc" id="L38">                    .item(insert)</span>
<span class="fc" id="L39">                    .conditionExpression(&quot;attribute_not_exists(&quot; + ID + &quot;)&quot;)</span>
<span class="fc" id="L40">                    .build());</span>

<span class="nc" id="L42">        } catch (ConditionalCheckFailedException | ResourceNotFoundException e) {</span>
<span class="nc" id="L43">            throw new DnaException(e.getMessage());</span>
<span class="fc" id="L44">        }</span>

<span class="fc" id="L46">	}</span>

	@Override
	public Statistics stats() throws DnaException {
		ScanResponse result;
		Statistics stats;
<span class="fc" id="L52">		Map&lt;String, String&gt; mutants = new HashMap&lt;&gt;();</span>
<span class="fc" id="L53">		Map&lt;String, String&gt; humans = new HashMap&lt;&gt;();</span>
		
<span class="fc" id="L55">		Map&lt;String, AttributeValue&gt; expresionHum = new HashMap&lt;String, AttributeValue&gt;(); </span>
<span class="fc" id="L56">		expresionHum.put(&quot;:mutant&quot;, AttributeValue.builder().bool(false).build());</span>
		
<span class="fc" id="L58">		Map&lt;String, AttributeValue&gt; expresionMut = new HashMap&lt;String, AttributeValue&gt;(); </span>
<span class="fc" id="L59">		expresionMut.put(&quot;:mutant&quot;, AttributeValue.builder().bool(true).build());</span>
<span class="fc" id="L60">		String filterExpresion =  &quot;#&quot;.concat(IS_MUTANT.concat(&quot; = :mutant&quot;));</span>
        try {
			
<span class="fc" id="L63">			mutants.put(&quot;#&quot;.concat(IS_MUTANT), IS_MUTANT);</span>
<span class="fc" id="L64">			humans.put(&quot;#&quot;.concat(IS_MUTANT), IS_MUTANT);</span>
<span class="fc" id="L65">			Builder scanRequest = ScanRequest.builder().tableName(tableName).filterExpression(filterExpresion)</span>
<span class="fc" id="L66">					.consistentRead(false).expressionAttributeNames(humans).expressionAttributeValues(expresionHum)</span>
<span class="fc" id="L67">					.select(Select.COUNT);</span>
			
			
			
<span class="nc" id="L71">			result = dynamoDb.scan(scanRequest.build());</span>
<span class="nc" id="L72">			stats = new Statistics();</span>
<span class="nc" id="L73">			stats.setCountHumanDna(result.count());</span>
			
<span class="nc" id="L75">			scanRequest = ScanRequest.builder().tableName(tableName).filterExpression(filterExpresion)</span>
<span class="nc" id="L76">					.consistentRead(false).expressionAttributeNames(mutants).expressionAttributeValues(expresionMut)</span>
<span class="nc" id="L77">					.select(Select.COUNT);</span>
<span class="nc" id="L78">			result = dynamoDb.scan(scanRequest.build());</span>
<span class="nc" id="L79">			stats.setCountMutantDna(result.count());</span>
			
<span class="nc" id="L81">			stats.calculateRatio();</span>
<span class="fc" id="L82">		} catch (ResourceNotFoundException e) {</span>
<span class="fc" id="L83">			throw new DnaException(&quot;Not exist registers&quot;);</span>
<span class="nc" id="L84">		}</span>
<span class="nc" id="L85">		return stats;</span>
	}
	
	protected Map&lt;String, AttributeValue&gt; transformDtoToMap(String dna, boolean isMutant) {
<span class="fc" id="L89">        Map&lt;String, AttributeValue&gt; item = new HashMap&lt;&gt;();</span>
        
<span class="fc" id="L91">        item.put(ID, AttributeValue.builder().s(UUID.randomUUID().toString()).build());</span>
<span class="fc" id="L92">        item.put(DNA, AttributeValue.builder().s(dna).build());</span>
<span class="fc" id="L93">        item.put(IS_MUTANT, AttributeValue.builder().bool(isMutant).build());</span>

<span class="fc" id="L95">        return item;</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>